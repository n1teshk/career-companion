<div class="page-header">
  <h1 class="page-title">Your Final Cover Letter and Video Pitch</h1>
  <h2 class="page-subtitle">
    Your final cover letter and video pitch are ready to be used
  </h2>
</div>

<div class="container-fluid">
  <div class="d-flex justify-content-center" style="width: 1400px; margin: 0 auto;">
    <div class="d-flex flex-column" style="width: 100%;">
      <div class="d-flex justify-content-between align-items-center mb-4 p-4 rounded-4 shadow bg-white border">
        <div class="pe-4">
          <h1 class="h4 mb-2">
            <strong class="text-secondary fw-normal">Role applied for:</strong>
            <strong class="text-dark"><%= @application.title %></strong>
          </h1>
          <h2 class="h6 text-muted mb-0">
            <strong class="fw-normal">Company:</strong>
            <span class="text-secondary"><%= @application.name %></span>
          </h2>
        </div>
        <div class="text-end text-muted small ps-4">
          <div class="mb-1">
            <strong>Created On:</strong> <%= @application.created_at.strftime("%b %d, %Y") %>
          </div>
          <div>
            <strong>Last Updated:</strong> <%= @application.updated_at.strftime("%b %d, %Y") %>
          </div>
        </div>
      </div>

      <div class="d-flex gap-4 align-items-start" style="width: 1400px;">
        <div class="d-flex flex-column gap-4" style="flex: 0 0 20%; max-width: 20%;">
          <div class="d-flex flex-column p-4 rounded-4 shadow bg-white border" style="height: 425px;">
            <h2 class="h5 mb-4 text-center"><strong>Your Selections</strong></h2>
            <div class="d-flex flex-column flex-grow-1">
              <div class="flex-grow-1 p-2 overflow-auto">
                <div class="mb-3">
                  <h6 class="small text-muted mb-2">Tone</h6>
                  <p class="small mb-0"><%= session[:trait_choice1] || "Not selected" %></p>
                </div>
                <hr class="my-3" style="border-color: #e0e0e0;">
                <div class="mb-3">
                  <h6 class="small text-muted mb-2">Professional Strength</h6>
                  <p class="small mb-0">
                    <% if session[:trait_choice2] == "Other" %>
                      <%= session[:trait_choice2_other] || "Not selected" %>
                    <% else %>
                      <%= session[:trait_choice2] || "Not selected" %>
                    <% end %>
                  </p>
                </div>
                <hr class="my-3" style="border-color: #e0e0e0;">
                <div class="mb-3">
                  <h6 class="small text-muted mb-2">Highlight an accomplishment</h6>
                  <p class="small mb-0">
                    <% if session[:trait_choice3] == "Other" %>
                      <%= session[:trait_choice3_other] || "Not selected" %>
                    <% else %>
                      <%= session[:trait_choice3] || "Not selected" %>
                    <% end %>
                  </p>
                </div>
                <hr class="my-3" style="border-color: #e0e0e0;">
                <div class="mb-3">
                  <h6 class="small text-muted mb-2">Video Pitch Personality</h6>
                  <p class="small mb-0">
                    <% if session[:trait_choice4] == "Other" %>
                      <%= session[:trait_choice4_other] || "Not selected" %>
                    <% else %>
                      <%= session[:trait_choice4] || "Not selected" %>
                    <% end %>
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex flex-column p-4 rounded-4 shadow bg-white border" style="height: 150px;">
            <h2 class="h5 mb-4 text-center"><strong>Documents</strong></h2>
            <div class="d-flex flex-column flex-grow-1">
              <div class="flex-grow-1 p-2">
                <% if @application.cv.attached? %>
                  <div class="d-flex align-items-center gap-2" style="min-width: 0;">
                    <a href="<%= url_for(@application.cv) %>" target="_blank" class="d-flex align-items-center text-decoration-none flex-grow-1" style="min-width: 0; overflow: hidden;">
                      <i class="bi bi-file-earmark-text me-2 flex-shrink-0"></i>
                      <span class="text-truncate" style="max-width: 100%;">
                        <%= @application.cv.filename %>
                      </span>
                    </a>
                    <a href="<%= url_for(@application.cv) %>" download="<%= @application.cv.filename %>" class="btn btn-sm flex-shrink-0" title="Download CV" style="color: #6c757d; border: none; background: none;">
                      <i class="bi bi-download"></i>
                    </a>
                  </div>
                <% else %>
                  <p class="text-muted small">No CV uploaded.</p>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex flex-column p-4 rounded-4 shadow bg-white border" style="flex: 0 0 38.25%; max-width: 38.25%; height: 600px;">
          <div class="d-flex align-items-center mb-4">
            <h2 class="h5 mb-0 text-center flex-grow-1"><strong>Final Cover Letter</strong></h2>
            <div class="d-flex gap-2 align-items-center">
              <button
                type="button"
                class="btn btn-sm"
                data-bs-toggle="modal"
                data-bs-target="#shareCoverLetterModal"
                title="Share cover letter"
                style="color: #6c757d; border: none; background: none;"
              >
                <i class="bi bi-share"></i>
              </button>
              <button
                type="button"
                class="btn btn-sm"
                data-controller="copy-share"
                data-action="click->copy-share#copyContent"
                data-copy-share-content-id-param="coverLetterContent"
                title="Copy to clipboard"
                style="color: #6c757d; border: none; background: none;"
              >
                <i class="bi bi-copy"></i>
              </button>
              <a
                class="btn btn-sm"
                href="data:text/plain;charset=utf-8,<%= ERB::Util.url_encode(@application.finals.last.cl || '') %>"
                download="cover_letter_<%= @application.title.parameterize.underscore %>.txt"
                title="Download as .txt"
                style="color: #6c757d; border: none; background: none;"
              >
                <i class="bi bi-download"></i>
              </a>
            </div>
          </div>
          <div class="d-flex flex-column flex-grow-1" style="min-height: 0;">
            <div id="coverLetterContent" class="p-2 overflow-auto flex-grow-1">
              <%= simple_format(@application.finals.last.cl) %>
              <% if (video = @application.videos.last) && video.file.attached? %>
                <% cloudinary_url = video.file.respond_to?(:url) ? video.file.url : url_for(video.file) %>
                <p>Please <a href="<%= cloudinary_url %>" target="_blank" rel="noopener">click here</a> to see the video.</p>
              <% end %>
            </div>
          </div>
        </div>

        <div class="d-flex flex-column p-4 rounded-4 shadow bg-white border" style="flex: 0 0 38.25%; max-width: 38.25%; height: 600px;">
          <div class="d-flex align-items-center mb-4">
            <h2 class="h5 mb-0 text-center flex-grow-1"><strong>Final Video Pitch</strong></h2>
            <% if (video = @application.videos.last) && video.file.attached? %>
              <div class="d-flex gap-2 align-items-center">
                <button
                  type="button"
                  class="btn btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#shareModal"
                  data-controller="copy-share"
                  data-action="click->copy-share#openShareModal"
                  data-copy-share-share-url-param="<%= video.file.respond_to?(:url) ? video.file.url : url_for(video.file) %>"
                  title="Share video link"
                  style="color: #6c757d; border: none; background: none;"
                >
                  <i class="bi bi-share"></i>
                </button>
                <a
                  href="<%= video.file.respond_to?(:url) ? video.file.url : url_for(video.file) %>"
                  download="<%= video.file.filename %>"
                  class="btn btn-sm"
                  title="Download Video"
                  style="color: #6c757d; border: none; background: none;"
                >
                  <i class="bi bi-download"></i>
                </a>
              </div>
            <% elsif @video&.file&.attached? %>
              <div class="d-flex gap-2 align-items-center">
                <button
                  type="button"
                  class="btn btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#shareModal"
                  data-controller="copy-share"
                  data-action="click->copy-share#openShareModal"
                  data-copy-share-share-url-param="<%= @video.file.url %>"
                  title="Share video link"
                  style="color: #6c757d; border: none; background: none;"
                >
                  <i class="bi bi-share"></i>
                </button>
                <a
                  href="<%= @video.file.url %>"
                  download="<%= @video.file.filename %>"
                  class="btn btn-sm"
                  title="Download Video"
                  style="color: #6c757d; border: none; background: none;"
                >
                  <i class="bi bi-download"></i>
                </a>
              </div>
            <% elsif @application.finals.last&.pitch.present? %>
              <div class="d-flex gap-2 align-items-center">
                <button
                  type="button"
                  class="btn btn-sm"
                  data-controller="copy-share"
                  data-action="click->copy-share#copyContent"
                  data-copy-share-content-id-param="videoPitchContent"
                  title="Copy pitch script"
                  style="color: #6c757d; border: none; background: none;"
                >
                  <i class="bi bi-copy"></i>
                </button>
                <a
                  class="btn btn-sm"
                  href="data:text/plain;charset=utf-8,<%= ERB::Util.url_encode(@application.finals.last.pitch || '') %>"
                  download="video_pitch_<%= @application.title.parameterize.underscore %>.txt"
                  title="Download pitch script"
                  style="color: #6c757d; border: none; background: none;"
                >
                  <i class="bi bi-download"></i>
                </a>
              </div>
            <% end %>
          </div>
          <div class="d-flex flex-column flex-grow-1" style="min-height: 0;">
            <div class="pt-4 px-2 d-flex justify-content-center align-items-start flex-grow-1 overflow-auto">
              <% if (video = @application.videos.last) && video.file.attached? %>
                <video controls style="width: 100%; height: auto; max-height: 100%;">
                  <source src="<%= video.file.respond_to?(:url) ? video.file.url : url_for(video.file) %>" type="<%= video.file.content_type %>">
                  Your browser does not support the video tag.
                </video>
              <% elsif @video&.file&.attached? %>
                <video controls style="width: 100%; height: auto; max-height: 100%;">
                  <source src="<%= @video.file.url %>" type="<%= @video.file.content_type %>">
                  Your browser does not support the video tag.
                </video>
              <% else %>
                <% if @application.finals.last&.pitch.present? %>
                  <div id="videoPitchContent" class="d-flex flex-wrap gap-3">
                    <% @application.finals.last.pitch.split("\n\n").each do |paragraph| %>
                      <% if paragraph.strip.present? %>
                        <div class="flex-fill">
                          <%= simple_format(paragraph) %>
                        </div>
                      <% end %>
                    <% end %>
                  </div>
                <% else %>
                  <div class="text-muted text-center">
                    <i class="bi bi-camera-video" style="font-size: 3rem;"></i>
                    <p class="mt-2">Video pitch will appear here when uploaded</p>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- ML Predictions Section -->
      <% if ApplicationConfig.ml_predictions_enabled? %>
        <div class="d-flex justify-content-center mt-4 mb-3">
          <div class="card border-primary" style="max-width: 600px; width: 100%;">
            <div class="card-header bg-primary text-white text-center">
              <h5 class="mb-0">
                <i class="bi bi-robot me-2"></i>
                AI-Powered Career Insights
              </h5>
            </div>
            <div class="card-body text-center">
              <p class="text-muted mb-3">
                Get ML predictions for your application success, salary expectations, and career path recommendations.
              </p>
              
              <div class="d-flex justify-content-center gap-2">
                <%= link_to application_ml_predictions_path(@application), 
                           class: "btn btn-outline-primary" do %>
                  <i class="bi bi-graph-up me-1"></i>
                  View ML Predictions
                <% end %>
                
                <% unless @application.ml_predictions.where(status: 'processing').exists? %>
                  <%= form_with url: generate_application_ml_prediction_path(@application), 
                               method: :post, class: "d-inline" do |form| %>
                    <%= form.submit "Generate New Predictions", 
                                   class: "btn btn-primary",
                                   data: { 
                                     confirm: "Generate new ML predictions for this application?",
                                     disable_with: "Generating..."
                                   } %>
                  <% end %>
                <% else %>
                  <span class="btn btn-secondary" disabled>
                    <i class="bi bi-hourglass-split me-1"></i>
                    Processing...
                  </span>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <div class="d-flex justify-content-center align-items-center gap-3" style="padding-top: 2rem; padding-bottom: 3rem;">
        <%= link_to "Go to Dashboard", applications_path, class: "btn btn-success px-3 py-2 rounded-3" %>
        <%= link_to "Create New Application", new_application_path, class: "btn btn-primary px-3 py-2 rounded-3" %>
      </div>
    </div>
  </div>
</div>

<div class="pb-3"></div>

<%= render "shared/share_modals" %>
